rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() && (
        (request.auth.token.admin == true)
        || (
          exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
        )
      );
    }

    // CAPSULAS
    match /capsulas/{capsId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.creadoPorUid == request.auth.uid
        && request.resource.data.titulo is string;

      allow update, delete: if isAdmin()
        || (
          isSignedIn()
          && resource.data.creadoPorUid == request.auth.uid
          && request.resource.data.creadoPorUid == resource.data.creadoPorUid
        );
    }

    // RETROALIMENTACIONES
    match /retroalimentaciones/{fbId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.usuarioUid == request.auth.uid
        && request.resource.data.capsulaId is string
        && request.resource.data.estrellas is int
        && request.resource.data.estrellas >= 1
        && request.resource.data.estrellas <= 5
        && fbId == (request.resource.data.capsulaId + '_' + request.auth.uid);

      allow update, delete: if (isSignedIn() && resource.data.usuarioUid == request.auth.uid) || isAdmin();
    }

    // USUARIOS y FAVORITOS
    match /usuarios/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow update: if isSignedIn() && (request.auth.uid == uid || isAdmin());

      match /favoritos/{capsulaId} {
        // Leer/Escribir solo el propietario (o admin)
        allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());

        // Crear o actualizar (set/merge) favorito
        allow create, update: if isSignedIn()
          && request.auth.uid == uid
          && request.resource.data.capsulaId == capsulaId
          && request.resource.data.capsulaId is string
          && (
            !request.resource.data.keys().hasAny(['createdAt'])
            || request.resource.data.createdAt is timestamp
          );

        // Eliminar favorito
        allow delete: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      }
    }

    // Denegar por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
