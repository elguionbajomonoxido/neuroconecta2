rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() && (
        // Prefer custom claim 'admin' if you set it
        (request.auth.token.admin == true)
        // Fallback: check usuarios collection
        || (exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin')
      );
    }
    // CAPSULAS
    match /capsulas/{capsId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.creadoPorUid == request.auth.uid
        && request.resource.data.titulo is string;
      allow update, delete: if isAdmin()
        || (isSignedIn()
            && resource.data.creadoPorUid == request.auth.uid
            && request.resource.data.creadoPorUid == resource.data.creadoPorUid);
    }

    // RETROALIMENTACIONES
    // RecomendaciÃ³n: usar ID = "${capsulaId}_${uid}" para forzar una sola por usuario
    match /retroalimentaciones/{fbId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.usuarioUid == request.auth.uid
        && request.resource.data.capsulaId is string
        && request.resource.data.estrellas is int
        && request.resource.data.estrellas >= 1
        && request.resource.data.estrellas <= 5
        // Si se usa ID compuesto, fuerza unicidad en el ID
        && fbId == (request.resource.data.capsulaId + '_' + request.auth.uid);
      allow update, delete: if (isSignedIn() && resource.data.usuarioUid == request.auth.uid) || isAdmin();
    }

    // CONFIG - groserias (solo admins escriben)
    match /config/groserias {
      allow read: if true;
      allow write: if isAdmin();
    }

    // USUARIOS
    match /usuarios/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow update: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == uid;
    }
  }
}
