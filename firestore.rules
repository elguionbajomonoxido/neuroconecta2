rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función auxiliar para verificar si es admin
    function isAdmin() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // Función para verificar si está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Colección Usuarios
    match /usuarios/{userId} {
      // Cada usuario puede leer y escribir su propio documento
      // Los admins pueden leer cualquier usuario
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Colección Cápsulas
    match /capsulas/{capsulaId} {
      // Cualquiera autenticado puede leer
      allow read: if isAuthenticated();
      
      // Solo admin puede crear, actualizar o borrar
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Colección Retroalimentaciones
    match /retroalimentaciones/{feedbackId} {
      // Cualquiera autenticado puede leer
      allow read: if isAuthenticated();
      
      // Cualquiera autenticado puede crear (validando que el uid coincida)
      allow create: if isAuthenticated() && request.resource.data.usuarioUid == request.auth.uid;
      
      // Solo el dueño o admin puede editar/borrar
      allow update, delete: if isAuthenticated() && (request.auth.uid == resource.data.usuarioUid || isAdmin());
    }
  }
}
